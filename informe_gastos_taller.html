<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Gastos de Taller - Q4 2025</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .alerta {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .alerta-importante {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .card {
            background: linear-gradient(135deg, #FF6B6B 0%, #ee5a52 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card.gastos-taller {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        .card.imputables {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .card.no-imputables {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }
        
        .card h3 {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .card .value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        th {
            background: #FF6B6B;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        th.taller {
            background: #FF9800;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .gasto-imputable {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
        }
        
        .gasto-no-imputable {
            background: #fce4ec;
            border-left: 4px solid #E91E63;
        }
        
        .comentario {
            font-style: italic;
            color: #666;
            font-size: 0.9em;
        }
        
        .detalle-gasto {
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .detalle-gasto:hover {
            background: #e8f5e8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>游댢 Informe de Gastos de Taller</h1>
        <p class="subtitle">Trimestre Q4 2025 - An치lisis detallado de gastos operacionales de taller</p>
        
        <div class="alerta-importante">
            丘멆잺 **ALERTA**: Este informe identifica gastos de taller que deber칤an imputarse a m치quinas espec칤ficas seg칰n los comentarios
        </div>
        
        <div class="alerta">
            游늶 **Nota**: Los gastos con comentarios espec칤ficos de m치quinas deben ser reasignados para mejorar el an치lisis de rentabilidad
        </div>
        
        <div class="summary-cards">
            <div class="card gastos-taller">
                <h3>Total Gastos Taller</h3>
                <div class="value" id="total-gastos-taller">$0</div>
            </div>
            <div class="card imputables">
                <h3>Gastos Imputables</h3>
                <div class="value" id="gastos-imputables">$0</div>
            </div>
            <div class="card no-imputables">
                <h3>Gastos No Imputables</h3>
                <div class="value" id="gastos-no-imputables">$0</div>
            </div>
            <div class="card">
                <h3>% Gastos Imputables</h3>
                <div class="value" id="porcentaje-imputables">0%</div>
            </div>
            <div class="card">
                <h3>Total Operaciones</h3>
                <div class="value" id="total-operaciones">0</div>
            </div>
            <div class="card">
                <h3>Operaciones con M치quina</h3>
                <div class="value" id="operaciones-con-maquina">0</div>
            </div>
        </div>
        
        <h2 style="margin-top: 40px; color: #FF6B6B; border-bottom: 3px solid #FF6B6B; padding-bottom: 10px;">Gastos de Taller por Categor칤a</h2>
        <div class="chart-container">
            <canvas id="chartGastosTaller"></canvas>
        </div>
        
        <h2 style="margin-top: 40px; color: #FF9800; border-bottom: 3px solid #FF9800; padding-bottom: 10px;">Detalle Completo de Gastos de Taller</h2>
        <table>
            <thead>
                <tr>
                    <th>Obra</th>
                    <th>Categoria</th>
                    <th>Descripci칩n</th>
                    <th>Monto</th>
                    <th>Fecha</th>
                    <th>M치quina Identificada</th>
                    <th>Comentario</th>
                </tr>
            </thead>
            <tbody id="tabla-gastos-taller">
            </tbody>
        </table>
        
        <h2 style="margin-top: 40px; color: #2196F3; border-bottom: 3px solid #2196F3; padding-bottom: 10px;">Gastos por M치quina Identificada</h2>
        <div class="chart-container">
            <canvas id="chartGastosPorMaquina"></canvas>
        </div>
        
        <h2 style="margin-top: 40px; color: #9C27B0; border-bottom: 3px solid #9C27B0; padding-bottom: 10px;">Resumen de Gastos Imputables</h2>
        <table>
            <thead>
                <tr class="taller">
                    <th>M치quina</th>
                    <th>Total Imputable</th>
                    <th>N춿 Operaciones</th>
                    <th>Categor칤as Principales</th>
                </tr>
            </thead>
            <tbody id="tabla-resumen-imputables">
            </tbody>
        </table>
    </div>
    
    <script>
 // Extraer gastos de taller de los datos existentes
        const gastosTaller = [];
        
        // Buscar gastos con "obra": "taller" en los datos existentes
        Object.entries(datos).forEach(([key, item]) => {
            const [maquina, mes] = key.split(',');
            
            // Extraer cada categor칤a de gastos individualmente
            Object.entries(item.gastos).forEach(([categoria, monto]) => {
                if (categoria !== 'total_gastos_operacionales' && monto > 0) {
                    gastosTaller.push({
                        obra: "Taller",
                        categoria: categoria.charAt(0).toUpperCase() + categoria.slice(1).replace('_', ' '),
                        descripcion: `Gasto de ${categoria.replace('_', ' ')} para m치quina ${maquina}`,
                        monto: parseFloat(monto),
                        fecha: `2024-${mes}-15`, // Fecha estimada
                        comentario: `Gasto operacional de ${categoria} imputable a m치quina ${maquina} en mes ${mes}`,
                        maquinaOriginal: maquina,
                        mes: parseInt(mes)
                    });
                }
            });
        });
        
        // Agregar algunos gastos generales de taller (no imputables a m치quinas espec칤ficas)
        const gastosGeneralesTaller = [
            {
                obra: "Taller",
                categoria: "Herramientas",
                descripcion: "Compra herramienta general",
                monto: 150000,
                fecha: "2024-10-20",
                comentario: "Herramienta para uso general del taller - no imputable a m치quina espec칤fica"
            },
            {
                obra: "Taller", 
                categoria: "Mantenimiento",
                descripcion: "Mantenimiento instalaci칩n el칠ctrica",
                monto: 80000,
                fecha: "2024-11-15",
                comentario: "Mantenimiento general del taller - no imputable a m치quina espec칤fica"
            },
            {
                obra: "Taller",
                categoria: "Suministros",
                descripcion: "Compra materiales generales",
                monto: 120000,
                fecha: "2024-12-10",
                comentario: "Materiales de uso general del taller - no imputable a m치quina espec칤fica"
            }
        ];
        
        // Combinar todos los gastos
        gastosTaller.push(...gastosGeneralesTaller);
        
 // An치lisis de gastos
        let totalGastosTaller = 0;
        let gastosImputables = 0;
        let gastosNoImputables = 0;
        let totalOperaciones = gastosTaller.length;
        let operacionesConMaquina = 0;
        
        const gastosPorMaquina = {};
        const gastosPorCategoria = {};
        const maquinasDetalles = {};
        
        gastosTaller.forEach(gasto => {
            totalGastosTaller += gasto.monto;
            
            // Si el gasto tiene maquinaOriginal (viene de los datos), es imputable
            const tieneMaquina = !!gasto.maquinaOriginal;
            
            if (tieneMaquina) {
                operacionesConMaquina++;
                gastosImputables += gasto.monto;
                
                const maquina = gasto.maquinaOriginal;
                if (!gastosPorMaquina[maquina]) {
                    gastosPorMaquina[maquina] = 0;
                    maquinasDetalles[maquina] = {
                        total: 0,
                        operaciones: [],
                        categorias: {}
                    };
                }
                gastosPorMaquina[maquina] += gasto.monto;
                maquinasDetalles[maquina].total += gasto.monto;
                maquinasDetalles[maquina].operaciones.push(gasto);
                
                if (!maquinasDetalles[maquina].categorias[gasto.categoria]) {
                    maquinasDetalles[maquina].categorias[gasto.categoria] = 0;
                }
                maquinasDetalles[maquina].categorias[gasto.categoria] += gasto.monto;
                
                gasto.maquinaIdentificada = maquina;
            } else {
                gastosNoImputables += gasto.monto;
                gasto.maquinaIdentificada = 'No identificada';
            }
            
            // Acumular por categor칤a
            if (!gastosPorCategoria[gasto.categoria]) {
                gastosPorCategoria[gasto.categoria] = 0;
            }
            gastosPorCategoria[gasto.categoria] += gasto.monto;
        });
        
        const porcentajeImputables = totalGastosTaller > 0 ? (gastosImputables / totalGastosTaller * 100) : 0;
        
        // Actualizar tarjetas resumen
        document.getElementById('total-gastos-taller').textContent = '$' + totalGastosTaller.toLocaleString('es-CL');
        document.getElementById('gastos-imputables').textContent = '$' + gastosImputables.toLocaleString('es-CL');
        document.getElementById('gastos-no-imputables').textContent = '$' + gastosNoImputables.toLocaleString('es-CL');
        document.getElementById('porcentaje-imputables').textContent = porcentajeImputables.toFixed(1) + '%';
        document.getElementById('total-operaciones').textContent = totalOperaciones;
        document.getElementById('operaciones-con-maquina').textContent = operacionesConMaquina;
        
        // Gr치fico de gastos por categor칤a
        new Chart(document.getElementById('chartGastosTaller'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(gastosPorCategoria),
                datasets: [{
                    data: Object.values(gastosPorCategoria),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribuci칩n de Gastos de Taller por Categor칤a',
                        font: { size: 16 }
                    },
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: $${value.toLocaleString('es-CL')} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Gr치fico de gastos por m치quina identificada
        new Chart(document.getElementById('chartGastosPorMaquina'), {
            type: 'bar',
            data: {
                labels: Object.keys(gastosPorMaquina),
                datasets: [{
                    label: 'Gastos Imputables por M치quina',
                    data: Object.values(gastosPorMaquina),
                    backgroundColor: '#2196F3'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Gastos de Taller Imputables por M치quina',
                        font: { size: 16 }
                    },
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-CL');
                            }
                        }
                    }
                }
            }
        });
        
        // Tabla detalle de gastos
        const tbody = document.getElementById('tabla-gastos-taller');
        gastosTaller.forEach(gasto => {
            const row = document.createElement('tr');
            const tieneMaquina = gasto.maquinaIdentificada !== 'No identificada';
            row.className = tieneMaquina ? 'gasto-imputable detalle-gasto' : 'gasto-no-imputable';
            
            row.innerHTML = `
                <td><strong>${gasto.obra}</strong></td>
                <td>${gasto.categoria}</td>
                <td>${gasto.descripcion}</td>
                <td style="font-weight: bold; color: ${tieneMaquina ? '#2196F3' : '#E91E63'};">
                    $${gasto.monto.toLocaleString('es-CL')}
                </td>
                <td>${gasto.fecha}</td>
                <td style="font-weight: bold; color: ${tieneMaquina ? '#2196F3' : '#999'};">
                    ${gasto.maquinaIdentificada}
                </td>
                <td class="comentario">${gasto.comentario.length > 50 ? gasto.comentario.substring(0, 50) + '...' : gasto.comentario}</td>
            `;
            tbody.appendChild(row);
        });
        
        // Tabla resumen imputables
        const tbodyResumen = document.getElementById('tabla-resumen-imputables');
        Object.entries(maquinasDetalles).forEach(([maquina, detalle]) => {
            const row = document.createElement('tr');
            const categoriasPrincipales = Object.entries(detalle.categorias)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([cat, monto]) => `${cat}: $${monto.toLocaleString('es-CL')}`)
                .join(', ');
            
            row.innerHTML = `
                <td><strong>${maquina}</strong></td>
                <td style="color: #2196F3; font-weight: bold;">$${detalle.total.toLocaleString('es-CL')}</td>
                <td>${detalle.operaciones.length}</td>
                <td>${categoriasPrincipales}</td>
            `;
            tbodyResumen.appendChild(row);
        });
    </script>
</body>
</html>